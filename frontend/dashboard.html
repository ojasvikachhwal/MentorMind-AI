<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MentorMind Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .navbar {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .nav-link {
            color: white !important;
        }
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .quiz-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .quiz-card:hover {
            transform: translateY(-5px);
        }
        .badge-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            background: white;
        }
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 15px;
            max-width: 80%;
        }
        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        .chat-message.bot {
            background: #f8f9fa;
            color: #333;
        }
        .voice-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
        .voice-btn.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .progress-ring {
            width: 120px;
            height: 120px;
        }
        .progress-ring-circle {
            stroke: #667eea;
            stroke-width: 8;
            fill: transparent;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>MentorMind
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link" id="userInfo">Welcome, Student!</span>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalQuizzes">0</div>
                    <p>Quizzes Completed</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="avgScore">0%</div>
                    <p>Average Score</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="streak">0</div>
                    <p>Day Streak</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="rank">#0</div>
                    <p>Leaderboard Rank</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Progress Chart -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-chart-line me-2"></i>Progress Overview</h5>
                    <canvas id="progressChart" width="400" height="200"></canvas>
                </div>

                <!-- Available Quizzes -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-question-circle me-2"></i>Available Quizzes</h5>
                    <div id="quizList">
                        <!-- Quizzes will be loaded here -->
                    </div>
                </div>

                <!-- Weak Areas -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h5>
                    <div id="weakAreas">
                        <!-- Weak areas will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4">
                <!-- AI Chatbot -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-robot me-2"></i>AI Tutor</h5>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message bot">
                            <strong>AI Tutor:</strong> Hello! I'm here to help you with your studies. Ask me anything about computer science concepts!
                        </div>
                    </div>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="chatInput" placeholder="Ask a question...">
                        <button class="btn btn-outline-secondary" type="button" onclick="startVoiceInput()">
                            <i class="fas fa-microphone" id="voiceIcon"></i>
                        </button>
                        <button class="btn btn-primary" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- Badges -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-trophy me-2"></i>Badges Earned</h5>
                    <div id="badgesList">
                        <!-- Badges will be loaded here -->
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="dashboard-card">
                    <h5><i class="fas fa-medal me-2"></i>Leaderboard</h5>
                    <div id="leaderboardList">
                        <!-- Leaderboard will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal fade" id="quizModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quizTitle">Quiz</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="quizContent">
                        <!-- Quiz content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitQuiz()">Submit Answer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API Base URL
        const API_BASE_URL = 'http://localhost:8000';
        let currentUser = null;
        let currentQuiz = null;
        let isRecording = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadDashboard();
            initializeProgressChart();
        });

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            // Load user info
            loadUserInfo();
        }

        // Load user information
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.full_name || currentUser.username}!`;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            await Promise.all([
                loadStats(),
                loadQuizzes(),
                loadWeakAreas(),
                loadBadges(),
                loadLeaderboard()
            ]);
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/performance/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalQuizzes').textContent = stats.total_quizzes_taken || 0;
                    document.getElementById('avgScore').textContent = `${Math.round((stats.average_score || 0) * 100)}%`;
                    document.getElementById('streak').textContent = stats.current_streak || 0;
                    document.getElementById('rank').textContent = `#${stats.rank || 0}`;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Set default values
                document.getElementById('totalQuizzes').textContent = '0';
                document.getElementById('avgScore').textContent = '0%';
                document.getElementById('streak').textContent = '0';
                document.getElementById('rank').textContent = '#0';
            }
        }

        // Load available quizzes
        async function loadQuizzes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/quizzes/available`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const quizzes = await response.json();
                    displayQuizzes(quizzes);
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                // Display sample quizzes
                displayQuizzes([
                    { id: 1, title: 'Basic Algorithms', topic: 'algorithms', difficulty: 'easy', question_count: 5 },
                    { id: 2, title: 'Data Structures', topic: 'data_structures', difficulty: 'medium', question_count: 8 },
                    { id: 3, title: 'Database Concepts', topic: 'database', difficulty: 'hard', question_count: 10 }
                ]);
            }
        }

        // Display quizzes
        function displayQuizzes(quizzes) {
            const quizList = document.getElementById('quizList');
            quizList.innerHTML = '';
            
            quizzes.forEach(quiz => {
                const quizCard = document.createElement('div');
                quizCard.className = 'quiz-card';
                quizCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>${quiz.title}</h6>
                            <p class="text-muted mb-0">Topic: ${quiz.topic} | Difficulty: ${quiz.difficulty} | Questions: ${quiz.question_count}</p>
                        </div>
                        <button class="btn btn-primary" onclick="startQuiz(${quiz.id})">
                            <i class="fas fa-play me-2"></i>Start Quiz
                        </button>
                    </div>
                `;
                quizList.appendChild(quizCard);
            });
        }

        // Start quiz
        async function startQuiz(quizId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/quizzes/${quizId}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    currentQuiz = await response.json();
                    showQuizModal();
                }
            } catch (error) {
                console.error('Error starting quiz:', error);
                // Show sample quiz
                currentQuiz = {
                    id: quizId,
                    title: 'Sample Quiz',
                    questions: [
                        {
                            id: 1,
                            text: 'What is the time complexity of binary search?',
                            options: ['O(1)', 'O(log n)', 'O(n)', 'O(nÂ²)'],
                            correct_answer: 1
                        }
                    ]
                };
                showQuizModal();
            }
        }

        // Show quiz modal
        function showQuizModal() {
            document.getElementById('quizTitle').textContent = currentQuiz.title;
            const quizContent = document.getElementById('quizContent');
            
            let html = '';
            currentQuiz.questions.forEach((question, index) => {
                html += `
                    <div class="mb-4">
                        <h6>Question ${index + 1}:</h6>
                        <p>${question.text}</p>
                        <div class="options">
                            ${question.options.map((option, optIndex) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="q${question.id}" value="${optIndex}">
                                    <label class="form-check-label">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            quizContent.innerHTML = html;
            
            new bootstrap.Modal(document.getElementById('quizModal')).show();
        }

        // Submit quiz
        async function submitQuiz() {
            const answers = [];
            currentQuiz.questions.forEach(question => {
                const selected = document.querySelector(`input[name="q${question.id}"]:checked`);
                answers.push(selected ? parseInt(selected.value) : -1);
            });

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/quizzes/${currentQuiz.id}/submit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers: answers })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`Quiz completed! Score: ${Math.round(result.score * 100)}%`);
                    bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
                    loadDashboard(); // Refresh dashboard
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('Quiz submitted successfully!');
                bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
                loadDashboard();
            }
        }

        // Load weak areas
        async function loadWeakAreas() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/performance/weak-areas`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const weakAreas = await response.json();
                    displayWeakAreas(weakAreas);
                }
            } catch (error) {
                console.error('Error loading weak areas:', error);
                displayWeakAreas(['Algorithms', 'Data Structures', 'Database Design']);
            }
        }

        // Display weak areas
        function displayWeakAreas(weakAreas) {
            const weakAreasDiv = document.getElementById('weakAreas');
            weakAreasDiv.innerHTML = '';
            
            weakAreas.forEach(area => {
                const areaDiv = document.createElement('div');
                areaDiv.className = 'alert alert-warning';
                areaDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>${area}</strong> - Consider reviewing this topic
                `;
                weakAreasDiv.appendChild(areaDiv);
            });
        }

        // Load badges
        async function loadBadges() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/gamification/badges`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const badges = await response.json();
                    displayBadges(badges);
                }
            } catch (error) {
                console.error('Error loading badges:', error);
                displayBadges([
                    { name: 'First Quiz', description: 'Completed your first quiz', icon: 'ðŸ†' },
                    { name: 'Streak Master', description: '7-day learning streak', icon: 'ðŸ”¥' }
                ]);
            }
        }

        // Display badges
        function displayBadges(badges) {
            const badgesList = document.getElementById('badgesList');
            badgesList.innerHTML = '';
            
            badges.forEach(badge => {
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'badge-card';
                badgeDiv.innerHTML = `
                    <div style="font-size: 2rem;">${badge.icon}</div>
                    <h6>${badge.name}</h6>
                    <small class="text-muted">${badge.description}</small>
                `;
                badgesList.appendChild(badgeDiv);
            });
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/gamification/leaderboard`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const leaderboard = await response.json();
                    displayLeaderboard(leaderboard);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                displayLeaderboard([
                    { username: 'Alice', score: 95, rank: 1 },
                    { username: 'Bob', score: 87, rank: 2 },
                    { username: 'Charlie', score: 82, rank: 3 }
                ]);
            }
        }

        // Display leaderboard
        function displayLeaderboard(leaderboard) {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            leaderboard.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'd-flex justify-content-between align-items-center mb-2';
                entryDiv.innerHTML = `
                    <div>
                        <span class="badge bg-primary me-2">#${entry.rank}</span>
                        <strong>${entry.username}</strong>
                    </div>
                    <span class="text-muted">${entry.score} pts</span>
                `;
                leaderboardList.appendChild(entryDiv);
            });
        }

        // Initialize progress chart
        function initializeProgressChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Average Score',
                        data: [65, 72, 78, 85],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const responses = [
                    "That's a great question! Let me explain...",
                    "I can help you with that. Here's what you need to know...",
                    "Based on your question, I recommend reviewing...",
                    "This concept is fundamental. Here's a breakdown..."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage('bot', randomResponse);
            }, 1000);
        }

        // Add message to chat
        function addMessage(sender, message) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI Tutor'}:</strong> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Voice input functionality
        function startVoiceInput() {
            const voiceBtn = document.getElementById('voiceIcon');
            if (!isRecording) {
                isRecording = true;
                voiceBtn.className = 'fas fa-stop';
                voiceBtn.parentElement.classList.add('recording');
                // Simulate voice recording
                setTimeout(() => {
                    stopVoiceInput();
                    addMessage('user', 'Voice input: Can you explain binary search?');
                    setTimeout(() => {
                        addMessage('bot', 'Binary search is an efficient algorithm for finding elements in a sorted array. It works by repeatedly dividing the search interval in half.');
                    }, 1000);
                }, 3000);
            } else {
                stopVoiceInput();
            }
        }

        function stopVoiceInput() {
            isRecording = false;
            const voiceBtn = document.getElementById('voiceIcon');
            voiceBtn.className = 'fas fa-microphone';
            voiceBtn.parentElement.classList.remove('recording');
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Enter key for chat
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
